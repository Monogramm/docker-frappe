##
##    Docker image for Frappe applications.
##    Copyright (C) 2020  Monogramm
##
##    This program is free software: you can redistribute it and/or modify
##    it under the terms of the GNU Affero General Public License as published
##    by the Free Software Foundation, either version 3 of the License, or
##    (at your option) any later version.
##
##    This program is distributed in the hope that it will be useful,
##    but WITHOUT ANY WARRANTY; without even the implied warranty of
##    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##    GNU Affero General Public License for more details.
##
##    You should have received a copy of the GNU Affero General Public License
##    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##
FROM python:3-alpine

ARG DOCKERIZE_VERSION=v0.6.1

# Frappe base environment
RUN set -ex; \
    apk add --update \
        wget \
        nodejs \
        nodejs-npm \
        git \
        alpine-sdk \
        linux-headers \
        busybox-suid \
        py-setuptools \
        python-dev \
        libffi-dev \
        openntpd \
        screen \
        mariadb-client \
        mariadb-common \
        mariadb-dev \
        postgresql-client \
        postgresql-dev \
        postgresql-libs \
        libxslt \
        libxslt-dev \
        py-openssl \
        py-ldap3 \
        python-psycopg2 \
        tiff-dev \
        jpeg-dev \
        lcms2-dev \
        libwebp-dev \
        zlib-dev \
        freetype-dev \
        xvfb \
        ttf-freefont \
        fontconfig \
        dbus \
        libxext \
        wkhtmltopdf \
    ; \
    mkdir /tmp/.X11-unix; \
    chmod 777 /tmp/.X11-unix; \
    chown root:root /tmp/.X11-unix; \
    node --version; \
    npm --version; \
    npm install -g yarn; \
    yarn --version; \
    mv /usr/bin/wkhtmltopdf /usr/bin/wkhtmltopdf-origin; \
    echo $'#!/usr/bin/env sh\n\
          Xvfb :0 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset & \n\
          DISPLAY=:0.0 wkhtmltopdf-origin $@ \n\
          killall Xvfb\
          ' > /usr/bin/wkhtmltopdf; \
    chmod +x /usr/bin/wkhtmltopdf; \
    wkhtmltopdf --version; \
    wget https://github.com/jwilder/dockerize/releases/download/${DOCKERIZE_VERSION}/dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz; \
    tar -C /usr/local/bin -xzvf dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz; \
    rm dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz; \
    rm -rf /var/lib/apt/lists/*; \
    rm -rf /var/cache/apk/*; \
    pip install --upgrade setuptools pip pip-tools; \
    pip --version

ARG VERSION=v12.3.0

# Build environment variables
ENV FRAPPE_USER=frappe \
    BENCH_BRANCH=master \
    FRAPPE_BRANCH=${VERSION}

RUN set -ex; \
    addgroup -S $FRAPPE_USER; \
    adduser -D -G $FRAPPE_USER $FRAPPE_USER; \
    echo 'frappe ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers

USER $FRAPPE_USER
WORKDIR /home/$FRAPPE_USER

# Setup Bench and Frappe
RUN set -ex; \
    test "$BENCH_BRANCH" = "4.1" && sudo pip install pip==9.0.3; \
    git clone -b $BENCH_BRANCH --depth 1 https://github.com/frappe/bench bench-repo; \
    sudo pip3 install -e /home/$FRAPPE_USER/bench-repo --no-cache-dir; \
    bench --version; \
    npm install \
        chalk \
        rollup \
        rollup-plugin-multi-entry \
        rollup-plugin-commonjs \
        rollup-plugin-node-resolve \
        rollup-plugin-uglify \
        rollup-plugin-postcss \
        rollup-plugin-buble \
        rollup-plugin-terser \
        rollup-plugin-vue \
        vue-template-compiler \
        moment \
    ; \
    test "$BENCH_BRANCH" = "4.1" && npm install \
        babel-core \
        babel-plugin-transform-object-rest-spread \
        babel-preset-env \
        touch \
    ; \
    bench setup socketio; \
    bench init \
        --frappe-branch $FRAPPE_BRANCH \
        --no-auto-update \
        --python $(which python3) \
        --skip-redis-config-generation --no-backups frappe-bench \
    ; \
    rm -rf node_modules; \
    cd frappe-bench; \
    mkdir -p apps logs sites config; \
    sed -i -e "s|^werkzeug$|werkzeug==0.16.1|g" apps/frappe/requirements.txt; \
    test ! "$FRAPPE_BRANCH" = "v10.x.x" && bench setup env --python $(which python3) ; \
    sudo bench setup sudoers $FRAPPE_USER

# Alternative: replace previous run by this for manual install
#RUN set -ex; \
#    mkdir -p frappe-bench; \
#    cd frappe-bench; \
#    mkdir -p apps logs sites config; \
#    bench setup env; \
#    sudo bench setup sudoers $FRAPPE_USER; \
#    bench get-app frappe https://github.com/frappe/frappe --branch $FRAPPE_BRANCH; \
#    cd /home/$FRAPPE_USER/frappe-bench/apps/frappe; \
#    npm install; \
#    cd /home/$FRAPPE_USER/frappe-bench; \
#    npm install babel-preset-env; \
#    rm -rf /home/$FRAPPE_USER/bench-repo/.git; \
#    rm -rf /home/$FRAPPE_USER/frappe-bench/apps/frappe/.git

# Runtime environment variables
ENV DOCKER_DB_TIMEOUT=120 \
    DOCKER_DB_ALLOWED_HOSTS= \
    DOCKER_SITES_TIMEOUT=600 \
    DOCKER_APPS_TIMEOUT=720 \
    DOCKER_INIT_TIMEOUT=300 \
    DOCKER_DEBUG= \
    DOCKER_GUNICORN_BIND_ADDRESS=0.0.0.0 \
    DOCKER_GUNICORN_PORT=8000 \
    DOCKER_GUNICORN_WORKERS=4 \
    DOCKER_GUNICORN_TIMEOUT=120 \
    DOCKER_GUNICORN_LOGLEVEL=info \
    FRAPPE_APP_INIT= \
    FRAPPE_APP_RESET= \
    FRAPPE_APP_PROTECTED=frappe \
    FRAPPE_DEFAULT_PROTOCOL= \
    FRAPPE_DEFAULT_SITE= \
    FRAPPE_RESET_SITES= \
    FRAPPE_REINSTALL_DATABASE= \
    FRAPPE_BUILD_OPTIONS= \
    FRAPPE_LOGGING=1 \
    GOOGLE_ANALYTICS_ID= \
    ALLOW_TESTS=0 \
    DEVELOPER_MODE=0 \
    ADMIN_PASSWORD=frappe \
    ENCRYPTION_KEY= \
    DB_TYPE=mariadb \
    DB_HOST=db \
    DB_PORT=3306 \
    DB_NAME=frappe \
    DB_PASSWORD=youshouldoverwritethis \
    DB_ROOT_LOGIN=root \
    DB_ROOT_PASSWORD=mariadb_root_password \
    MAIL_MUTED=false \
    MAIL_HOST=mail \
    MAIL_PORT=587 \
    MAIL_USE_SSL=1 \
    MAIL_LOGIN=frappe-mail \
    MAIL_PASSWORD=youshouldoverwritethis \
    MAIL_EMAIL_ID= \
    MAIL_SENDER_NAME=Notifications \
    MAIL_ALWAYS_EMAIL_ID_AS_SENDER=0 \
    MAIL_ALWAYS_NAME_AS_SENDER_NAME=0 \
    REDIS_CACHE_HOST=redis_cache \
    REDIS_QUEUE_HOST=redis_queue \
    REDIS_SOCKETIO_HOST=redis_socketio

# Copy docker entrypoint and private install script
ADD ./entrypoint.sh /

# Set permissions
RUN set -ex; \
    sudo chmod +x \
        /entrypoint.sh \
    ; \
    sudo mkdir -p "/home/$FRAPPE_USER"/frappe-bench/logs; \
    sudo touch "/home/$FRAPPE_USER"/frappe-bench/logs/bench.log; \
    sudo chmod +rw \
        "/home/$FRAPPE_USER"/frappe-bench/logs \
        "/home/$FRAPPE_USER"/frappe-bench/logs/* \
    ; \
    sudo chown -R "${FRAPPE_USER}:${FRAPPE_USER}" \
        "/home/$FRAPPE_USER/frappe-bench" \
    ;

VOLUME /home/$FRAPPE_USER/bench-repo \
    /home/$FRAPPE_USER/frappe-bench/logs \
    /home/$FRAPPE_USER/frappe-bench/sites \
    /home/$FRAPPE_USER/frappe-bench/apps/frappe/frappe/public

WORKDIR /home/$FRAPPE_USER/frappe-bench

ENTRYPOINT ["/entrypoint.sh"]
CMD ["app"]

ARG TAG
ARG VCS_REF
ARG BUILD_DATE

LABEL maintainer="Monogramm Maintainers <opensource at monogramm dot io>" \
      product="Frappe" \
      version=$VERSION \
      org.label-schema.vcs-ref=$VCS_REF \
      org.label-schema.vcs-url="https://github.com/Monogramm/docker-frappe" \
      org.label-schema.build-date=$BUILD_DATE \
      org.label-schema.name="Frappe" \
      org.label-schema.description="Python + JS based metadata driven, full-stack web-application framework." \
      org.label-schema.url="https://frappe.io/" \
      org.label-schema.vendor="Frapp√© Technologies Pvt. Ltd" \
      org.label-schema.version=$VERSION \
      org.label-schema.schema-version="1.0"

# Docker built environment variables
ENV DOCKER_TAG=${TAG} \
    DOCKER_VCS_REF=${VCS_REF} \
    DOCKER_BUILD_DATE=${BUILD_DATE}
